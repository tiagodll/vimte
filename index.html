<html>
    <head>
        <title>vim game</title>
        <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/csharp.min.js"></script> -->
        <!-- HTML -->
        <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/dark.min.css"> -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/vs.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css" />
        <link rel="stylesheet" href="./app.css" />

        <script src="./navigationHelper.js"></script>
        <script src="./normalMode.js"></script>
    </head>
</head>
<body>
    <script type="module">
      import hljs from 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/es/highlight.min.js';
      //  and it's easy to individually load additional languages
      import csharp from 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/es/languages/csharp.min.js';
      hljs.registerLanguage('csharp', csharp);

      document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('pre.code').forEach((el) => {
          el.textContent = document.getElementById("codestring").innerText;
          hljs.highlightElement(el);
          document.getElementById("statusbar").innerText = `[${mode}] ${line}:${col} - ${code[line].length}`;
        })
      })
    </script>
    <div class="code-container">
        <pre id="codestring" class="codestring" style="display:none">
using System;
using System.Linq;
using xxx;

namespace dis_test;
internal class Program
{
    public static void Main(string[] args)
    {
        var docid = "14724c8a0n8anwpw98nawlwiuhwL*$rwy8";
        for(int i=0; i<2; i++)
        {
            var asd = new DisClient(asd, qwe);
            asd.value = "new value";

            Console.Write(asd.ToString());
        }
    }
}
        </pre>
        <pre class="code"></pre>
        <div id="cursor">_</div>
    </div>
    <div id="statusbar"></div>
    <script type="text/javascript">
      var mode='normal';
      var col=0;
      var line=0;
      const nonSpaceDelimiters = ['(', '[', '{', ')', ']', '}', '.', ',', ';']
      const delimiters = [...nonSpaceDelimiters, ' ', '']
      function setCaret(pos){
        col = pos.col;
        line = pos.line;
      }
      function getCaret(){
        return {line: line, col: col};
      }
      var code = document.getElementById("codestring").innerText.split("\n");
      normalMode = NewNormalMode(code);

      window.addEventListener('keydown', (e) => {
        switch (e.code){
          case "Escape": mode = 'normal'; break;
          default:
            switch(mode){
              case 'normal': processKeyNormalMode(e.key);break;
              case 'visual': processKeyVisualMode(e.key);break;
              case 'insert': processKeyInsertMode(e.key);break;
            }
        }
        document.getElementById("statusbar").innerText = `[${mode}] ${line}:${col} - ${code[line].length} - ${e.code}`;
      })

      function processKeyNormalMode(key) {
        let c = document.getElementById('cursor');
        let pos = getCaret();
        switch(key){
          case "0": pos.col = 0; break;
          case "$": pos.col = code[pos.line].length; break;

          case "h": pos = normalMode.moveLeft(pos);break;
          case "j": pos = normalMode.moveDown(pos);break;
          case "k": pos = normalMode.moveUp(pos);break;
          case "l": pos = normalMode.moveRight(pos);break;

          case "w": pos = normalMode.nextWord(pos); break;
          case "e": pos = normalMode.nextEndOfWord(pos); break;
          case "b": pos = normalMode.previousWord(pos); break;

          case "i": mode = 'insert'; break;
          case "v": mode = 'visual'; break;
        }
        let cursorCol = pos.col < code[pos.line].length ? pos.col : code[pos.line].length - 1;
        if(cursorCol < 0)
          cursorCol = 0;

        c.style.left = (cursorCol * 1.23) + "ch";
        c.style.top = (pos.line * 1.2) + "rem";
        setCaret(pos);
      }
      function processKeyInsertMode(key) {
        let c=document.getElementById('cursor');

        var cursorCol = col < code[line].length ? col : code[line].length - 1;
        if(cursorCol < 0)
          cursorCol = 0;

        c.style.left = (cursorCol * 1.23) + "ch";
        c.style.top = (line * 1.2) + "rem";
      }
      function processKeyVisualMode(key) {
        let c=document.getElementById('cursor');

        var cursorCol = col < code[line].length ? col : code[line].length - 1;
        if(cursorCol < 0)
          cursorCol = 0;

        c.style.left = (cursorCol * 1.23) + "ch";
        c.style.top = (line * 1.2) + "rem";
      }
    </script>
</body>
</html>
